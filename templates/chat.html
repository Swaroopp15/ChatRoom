<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <title>Chat Room {{ room_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <style>
    /* Glass + Neumorphism Effect */
    .glass-effect {
      backdrop-filter: blur(20px) saturate(160%);
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    .dark .glass-effect {
      background: rgba(20, 20, 20, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Chat bubbles */
    .message-left, .message-right {
      position: relative;
      max-width: 80%;
      animation: fadeInUp 0.35s ease forwards;
      word-wrap: break-word;
    }
    .message-left:hover, .message-right:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 18px rgba(0,0,0,0.2);
    }
    .message-left::after, .message-right::after {
      content: attr(data-time);
      font-size: 0.65rem;
      position: absolute;
      bottom: -1.2rem;
      opacity: 0.6;
      white-space: nowrap;
    }
    .message-left::after { left: 0.5rem; }
    .message-right::after { right: 0.5rem; }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Typing dots */
    .typing-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: currentColor;
      margin: 0 2px;
      animation: bounce 1.4s infinite ease-in-out;
    }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1.2); opacity: 1; }
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(156,163,175,.4); border-radius: 3px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(75,85,99,.5); }

    /* Emoji Picker */
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      left: 10px;
      z-index: 50;
      width: 280px;
      max-height: 240px;
      overflow-y: auto;
      border-radius: 14px;
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
    }
    .dark .emoji-picker {
      background: rgba(30, 30, 30, 0.9);
    }
    .emoji-item {
      font-size: 1.4rem;
      cursor: pointer;
      text-align: center;
      transition: transform 0.2s, filter 0.2s;
    }
    .emoji-item:hover {
      transform: scale(1.35);
      filter: brightness(1.3);
    }

    /* Sidebar */
    #sidebar {
      backdrop-filter: blur(12px);
    }
    #sidebar ul li {
      transition: background 0.2s;
    }
    #sidebar ul li:hover {
      background: rgba(255,255,255,0.15);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      #sidebar {
        width: 80%;
      }
      .message-left, .message-right {
        max-width: 90%;
      }
      footer {
        padding: 0.6rem;
      }
    }
    @media (max-width: 480px) {
      header h2 {
        font-size: 1rem;
      }
      #sidebar {
        width: 100%;
      }
      footer input {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
      }
      .emoji-picker {
        width: 90%;
        left: 50%;
        transform: translateX(-50%);
      }
    }

    /* Mobile Sidebar overlay */
    .mobile-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:40; display:none; }
    .mobile-overlay.active { display:block; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 via-pink-100 to-blue-200 dark:from-gray-900 dark:to-black flex flex-col p-0 sm:p-4 transition-colors duration-500">

<div class="flex flex-1 h-screen max-h-screen overflow-hidden relative">

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed sm:relative left-0 top-0 h-full w-64 bg-white/10 dark:bg-black/30 text-white border-r border-white/20 p-5 transform -translate-x-full sm:translate-x-0 transition-transform duration-300 z-50">
    <div class="flex items-center justify-between mb-5">
      <h3 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-users"></i> Users</h3>
      <span id="userCount" class="text-xs bg-purple-600 text-white rounded-full px-2 py-0.5">0</span>
    </div>
    <ul id="userList" class="space-y-2 text-sm custom-scrollbar overflow-y-auto pr-1 h-[calc(100%-120px)]"></ul>
    <div class="mt-auto pt-5 border-t border-white/20 text-xs text-gray-400">
      <p>Room: <span class="font-mono">{{ room_id }}</span></p>
      <p>Encrypted • No data stored</p>
    </div>
  </aside>

  <!-- Mobile overlay -->
  <div id="overlay" class="mobile-overlay"></div>

  <!-- Chat Section -->
  <section class="flex-1 flex flex-col ml-0 sm:ml-64">

    <!-- Header -->
    <header class="flex items-center p-4 bg-gradient-to-r from-indigo-700 via-purple-600 to-pink-600 text-white shadow-md">
      <button id="sidebar-toggle" class="p-2 rounded-lg bg-white/20 hover:bg-white/30 transition sm:hidden mr-3"><i class="fas fa-users"></i></button>
      <div>
        <h2 class="text-lg font-bold">Room: {{ room_id }}</h2>
        <p class="text-xs opacity-80">Live chat • Private</p>
      </div>
      <div class="ml-auto flex gap-2">
        <button onclick="toggleTheme()" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition"><i class="fas fa-moon"></i></button>
      </div>
    </header>

    <!-- Chat Area -->
    <main id="chat" class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-6 bg-gradient-to-b from-white/20 to-transparent dark:from-white/5 dark:to-transparent custom-scrollbar">
      <div class="text-center text-gray-600 dark:text-gray-300 italic text-sm">Welcome to the chat!</div>
    </main>

    <!-- Typing Indicator -->
    <div id="typingIndicator" class="hidden px-5 pb-3 text-sm text-gray-600 dark:text-gray-400 flex items-center">
      <div class="typing-indicator">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
      <span class="ml-2">Someone is typing...</span>
    </div>

    <!-- Input -->
    <footer class="p-3 sm:p-4 bg-white/20 dark:bg-black/20 border-t border-white/20 flex items-center gap-2 relative glass-effect">
      <div id="emojiPicker" class="emoji-picker glass-effect hidden"></div>
      <button id="emojiBtn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition"><i class="fas fa-smile"></i></button>
      <input id="fileInput" type="file" class="hidden">
      <label for="fileInput" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 cursor-pointer transition"><i class="fas fa-paperclip"></i></label>
      <input id="messageInput" type="text" placeholder="Type a message..." autocomplete="off"
             class="flex-1 px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 bg-white/80 dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent transition">
      <button id="sendBtn" class="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 active:scale-95 transition"><i class="fas fa-paper-plane"></i></button>
    </footer>
  </section>
</div>

<script>
  const socket = io();
  const roomId = "{{ room_id }}";
  const username = "{{ username }}";

  const chat = document.getElementById("chat");
  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const fileInput = document.getElementById("fileInput");
  const userList = document.getElementById("userList");
  const userCount = document.getElementById("userCount");
  const sidebarToggle = document.getElementById('sidebar-toggle');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');

  // Sidebar toggle
  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('active');
  });
  overlay.addEventListener('click', ()=>{
    sidebar.classList.add('-translate-x-full');
    overlay.classList.remove('active');
  });

  // Emoji Picker
  const emojis = ['😀','😃','😄','😁','😆','😅','😂','🤣','😊','😇','🙂','🙃','😉','😍','🥰','😘','😎','🤩','🤔','😴','🥳','😢'];
  emojis.forEach(e=>{
    const el = document.createElement('div'); el.className='emoji-item'; el.textContent=e;
    el.addEventListener('click',()=>{ input.value+=e; input.focus(); });
    emojiPicker.appendChild(el);
  });
  emojiBtn.addEventListener('click',()=>emojiPicker.classList.toggle('hidden'));
  document.addEventListener('click', e => { if(!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) emojiPicker.classList.add('hidden'); });

  // Append message
  function appendMessage(role,msg,isSelf=false){
    const wrapper=document.createElement('div');
    wrapper.className=`flex items-start gap-2 ${isSelf?'justify-end':'justify-start'}`;
    const bubble=document.createElement('div');
    const time=new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    bubble.className=`px-4 py-3 rounded-2xl shadow-md ${isSelf?'bg-gradient-to-r from-green-500 to-emerald-600 text-white message-right':'bg-gradient-to-r from-sky-500 to-indigo-600 text-white message-left'}`;
    bubble.setAttribute("data-time", time);
    bubble.innerHTML=`<p class="text-xs font-semibold mb-1 opacity-90">${isSelf?'You':role}</p><p class="text-sm break-words">${msg}</p>`;
    wrapper.appendChild(bubble);
    chat.appendChild(wrapper);
    chat.scrollTo({top: chat.scrollHeight, behavior:'smooth'});
  }

  function sendMessage(){ 
    const msg=input.value.trim(); 
    if(msg){ 
      socket.emit('send_message',{room:roomId,username,msg}); 
      appendMessage(username,msg,true); 
      input.value=''; 
    } 
  }
  sendBtn.addEventListener('click',sendMessage);
  input.addEventListener('keydown', e => { if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); } });

  socket.on('receive_message', data=>appendMessage(data.role,data.msg,data.role===username));
  socket.on('update_users', users=>{
    userList.innerHTML=''; 
    userCount.textContent=users.length; 
    users.forEach(u=>{
      const li=document.createElement('li'); 
      li.className='p-3 rounded-lg bg-white/10 flex items-center gap-3'; 
      const status=document.createElement('div'); 
      status.className='w-3 h-3 bg-green-500 rounded-full'; 
      const info=document.createElement('div'); 
      info.innerHTML=`<p class="font-medium text-gray-200">${u===username?u+' (You)':u}</p><p class="text-xs text-gray-400">Online</p>`; 
      li.appendChild(status); li.appendChild(info); 
      userList.appendChild(li); 
    }); 
  });

  document.addEventListener('DOMContentLoaded',()=>{ socket.emit('join',{room:roomId,username}); });
  function toggleTheme(){ document.documentElement.classList.toggle('dark'); }
</script>
</body>
</html>
